package com.org.shoppingcart.core.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;
import org.springframework.amqp.support.converter.MessageConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.google.gson.Gson;
import com.org.shoppingcart.core.config.GsonUtil;
import com.org.shoppingcart.core.request.ProductRequest;
import com.org.shoppingcart.core.service.ShoppingCartService;
import com.rabbitmq.client.Channel;

@Component
public class ShoppingCartMessageListener implements ChannelAwareMessageListener {
	private Logger logger;
	private MessageConverter messageConverter;

	@Autowired
	private ShoppingCartService shoppingCartService;

	public ShoppingCartMessageListener(MessageConverter messageConverter, ShoppingCartService shoppingCartService) {
		this.logger = LoggerFactory.getLogger(this.getClass());
		this.messageConverter = messageConverter;
		this.shoppingCartService = shoppingCartService;
	}

	@Override
	public void onMessage(Message message, Channel channel) throws Exception {
		logger.info("Message received.");
		try {
			String strMessage = this.messageConverter.fromMessage(message).toString();
			ProductRequest request = GsonUtil.getFromObject(strMessage, ProductRequest.class);
			boolean result = shoppingCartService.saveAll(request);
			logger.info("Message Receiverd : channel close");
			// Acknowledge to delete from the queue
			if (result) {
				logger.info("Result Success.End message from message Queue");
				channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);
			}

		} catch (Exception e) {
			logger.info("Error..........");
			e.printStackTrace();
		}
	}

}
